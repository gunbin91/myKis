{% extends "base.html" %}

{% block content %}
<div class="row">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0"><i class="fas fa-book me-2"></i>매매일지</h4>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-light" id="btn-diary-refresh"><i class="fas fa-sync-alt"></i></button>
      </div>
    </div>
    <div class="alert alert-warning py-2 d-none" id="diary-mock-note">
      <div class="small">
        <strong>모의투자 안내</strong><br/>
        - 기간손익(해외주식-032) 미지원 → 체결내역(해외주식-007) 기반으로 <strong>참고용 집계</strong>합니다.<br/>
        - 손익/수익률은 실제와 다를 수 있으며, 일부 값은 0으로 표시될 수 있습니다.
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-3">
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <div class="text-muted">총 매매 건수</div>
        <div class="fs-4 fw-bold" id="diary-total-trades">-</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <div class="text-muted">총 실현손익 <span class="badge bg-secondary ms-1" id="diary-total-profit-badge">USD</span></div>
        <div class="fs-4 fw-bold" id="diary-total-profit">-</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <div class="text-muted">총 수익률</div>
        <div class="fs-4 fw-bold" id="diary-total-rate">-</div>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card">
      <div class="card-body">
        <div class="text-muted">데이터 소스</div>
        <div class="fw-bold" id="diary-source">-</div>
        <div class="small text-muted" id="diary-note"></div>
      </div>
    </div>
  </div>
</div>

<div class="card mb-3">
  <div class="card-header">
    <strong>기간 조회</strong>
  </div>
  <div class="card-body">
    <div class="row g-2 align-items-end mb-2">
      <div class="col-md-3">
        <label class="form-label">시작일</label>
        <input type="date" class="form-control" id="diary-from" />
      </div>
      <div class="col-md-3">
        <label class="form-label">종료일</label>
        <input type="date" class="form-control" id="diary-to" />
      </div>
      <div class="col-md-3">
        <label class="form-label">거래소(실전 옵션)</label>
        <select class="form-select" id="diary-exchange">
          <option value="">전체</option>
          <option value="NASD">미국(NASD)</option>
          <option value="SEHK">홍콩(SEHK)</option>
          <option value="SHAA">중국(SHAA)</option>
          <option value="TKSE">일본(TKSE)</option>
          <option value="HASE">베트남(HASE)</option>
        </select>
      </div>
    </div>
    <div class="row g-2 align-items-end">
      <div class="col-md-3">
        <label class="form-label">손익 필터</label>
        <select class="form-select" id="diary-profit-filter">
          <option value="">전체</option>
          <option value="profit">수익</option>
          <option value="loss">손실</option>
          <option value="zero">보합</option>
        </select>
      </div>
      <div class="col-md-3 d-flex gap-2">
        <button class="btn btn-primary w-100" id="btn-diary-search">
          <i class="fas fa-search me-1"></i>조회
        </button>
      </div>
      <div class="col-md-6">
        <div class="small text-muted mt-1">수익(+)은 빨강, 손실(-)은 파랑으로 표시합니다.</div>
      </div>
    </div>
  </div>
</div>

<ul class="nav nav-tabs mb-3" id="diaryTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="diary-daily-tab" data-bs-toggle="tab" data-bs-target="#diary-daily" type="button" role="tab">
      <i class="fas fa-calendar-day me-1"></i>일별 매매일지
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="diary-chart-tab" data-bs-toggle="tab" data-bs-target="#diary-chart" type="button" role="tab">
      <i class="fas fa-chart-column me-1"></i>일별 손익 그래프
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="diary-cum-tab" data-bs-toggle="tab" data-bs-target="#diary-cum" type="button" role="tab">
      <i class="fas fa-chart-line me-1"></i>누적 손익 그래프
    </button>
  </li>
</ul>

<div class="tab-content" id="diaryTabContent">
  <div class="tab-pane fade show active" id="diary-daily" role="tabpanel">
    <div class="card">
      <div class="card-header">
        <strong>일별 손익 내역</strong>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-dark table-hover mb-0 align-middle">
            <thead>
              <tr>
                <th>일자</th>
                <th class="text-end">매도수량</th>
                <th class="text-end">매입금액 <span class="badge bg-secondary" id="diary-th-buy-badge">USD</span></th>
                <th class="text-end">매도금액 <span class="badge bg-secondary" id="diary-th-sell-badge">USD</span></th>
                <th class="text-end">실현손익 <span class="badge bg-secondary" id="diary-th-profit-badge">USD</span></th>
                <th class="text-end">수익률</th>
                <th class="text-end">상세</th>
              </tr>
            </thead>
            <tbody id="diary-tbody">
              <tr><td colspan="7" class="text-center text-muted py-4">로딩 중...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="tab-pane fade" id="diary-chart" role="tabpanel">
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>일별 손익 그래프</strong>
      </div>
      <div class="card-body">
        <canvas id="diaryChart" height="110"></canvas>
      </div>
    </div>
  </div>
  <div class="tab-pane fade" id="diary-cum" role="tabpanel">
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <strong>누적 손익 그래프</strong>
      </div>
      <div class="card-body">
        <canvas id="diaryCumChart" height="110"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="diaryDetailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content bg-dark border-secondary">
      <div class="modal-header border-secondary">
        <h5 class="modal-title" id="diaryDetailTitle">일별 매매 상세</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="diaryDetailBody">
        <div class="text-muted">로딩 중...</div>
      </div>
      <div class="modal-footer border-secondary">
        <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">닫기</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
  let chart;
  let cumChart;
  let diaryRowsAll = [];
  let diaryDetailMap = {};

  function updateCurrencyLabels(){
    try{
      const m = (window.CurrencyPref && window.CurrencyPref.getMode) ? window.CurrencyPref.getMode() : 'USD';
      const isKrw = (m === 'KRW');
      const unit = isKrw ? 'KRW' : 'USD';
      const badges = [
        document.getElementById('diary-total-profit-badge'),
        document.getElementById('diary-th-buy-badge'),
        document.getElementById('diary-th-sell-badge'),
        document.getElementById('diary-th-profit-badge'),
      ];
      for(const el of badges){
        if(!el) continue;
        el.textContent = unit;
        el.classList.toggle('bg-secondary', !isKrw);
        el.classList.toggle('bg-info', isKrw);
        el.classList.toggle('text-dark', isKrw);
        el.title = isKrw ? 'USD 값을 환율로 원화 환산해 표시합니다.' : 'USD 기준 표시입니다.';
      }
    }catch(e){}
  }

  function toYMD(date){
    const y = date.getFullYear();
    const m = (date.getMonth()+1).toString().padStart(2,'0');
    const d = date.getDate().toString().padStart(2,'0');
    return `${y}-${m}-${d}`;
  }

  function fmt(n){
    if(n === null || n === undefined) return '-';
    const x = (''+n).replace(/,/g,'');
    const v = parseFloat(x);
    if(isNaN(v)) return n;
    return v.toLocaleString();
  }

  function initDates(){
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 30);
    const f = document.getElementById('diary-from');
    const t = document.getElementById('diary-to');
    if(!f.value) f.value = toYMD(start);
    if(!t.value) t.value = toYMD(end);
  }

  function renderChart(labels, values){
    const ctx = document.getElementById('diaryChart');
    if(chart) chart.destroy();

    const pref = (window.CurrencyPref && window.CurrencyPref.getMode) ? window.CurrencyPref.getMode() : 'USD';
    const isKrw = (pref === 'KRW');
    const sym = isKrw ? '₩' : '$';
    const colors = values.map(v => v >= 0 ? 'rgba(220, 53, 69, 0.75)' : 'rgba(13, 110, 253, 0.75)');
    const borderColors = values.map(v => v >= 0 ? 'rgba(220, 53, 69, 1)' : 'rgba(13, 110, 253, 1)');
    chart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: `일별 실현손익 (${sym})`,
          data: values,
          backgroundColor: colors,
          borderColor: borderColors,
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: false }
        }
      }
    });
  }

  function renderCumChart(labels, values){
    const ctx = document.getElementById('diaryCumChart');
    if(cumChart) cumChart.destroy();

    const pref = (window.CurrencyPref && window.CurrencyPref.getMode) ? window.CurrencyPref.getMode() : 'USD';
    const isKrw = (pref === 'KRW');
    const sym = isKrw ? '₩' : '$';
    cumChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels,
        datasets: [{
          label: `누적 손익 (${sym})`,
          data: values,
          borderColor: 'rgba(13, 202, 240, 0.95)',
          backgroundColor: 'rgba(13, 202, 240, 0.15)',
          borderWidth: 2,
          pointRadius: 2,
          pointHoverRadius: 4,
          tension: 0.25,
          fill: true
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: false }
        }
      }
    });
  }

  function profitClass(v){
    const x = parseFloat((''+(v ?? '')).replace(/,/g,''));
    if(isNaN(x) || x === 0) return 'text-muted';
    return x > 0 ? 'text-up' : 'text-down';
  }

  function applyDiaryFilter(){
    const filter = document.getElementById('diary-profit-filter')?.value || '';
    let rows = (diaryRowsAll || []).slice();
    if(filter === 'profit'){
      rows = rows.filter(r => parseFloat((''+(r.profit ?? 0)).replace(/,/g,'')) > 0);
    }else if(filter === 'loss'){
      rows = rows.filter(r => parseFloat((''+(r.profit ?? 0)).replace(/,/g,'')) < 0);
    }else if(filter === 'zero'){
      rows = rows.filter(r => parseFloat((''+(r.profit ?? 0)).replace(/,/g,'')) === 0);
    }
    renderDiaryRows(rows);
  }

  function setDetailRows(detailRows){
    diaryDetailMap = {};
    if(!detailRows || !Array.isArray(detailRows)) return;
    for(const r of detailRows){
      const d = r?.date;
      if(!d) continue;
      if(!diaryDetailMap[d]) diaryDetailMap[d] = [];
      diaryDetailMap[d].push(r);
    }
  }

  function renderDiaryRows(rows){
    const tbody = document.getElementById('diary-tbody');
    const money = (v, digits=2)=>{
      try{
        if(window.CurrencyPref) return window.CurrencyPref.formatMoney(v, 'USD', {digits});
      }catch(e){}
      const x = parseFloat((''+(v ?? '')).replace(/,/g,''));
      if(isNaN(x)) return '-';
      return '$' + x.toLocaleString(undefined,{maximumFractionDigits: digits});
    };

    if(!rows || rows.length === 0){
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">내역이 없습니다.</td></tr>';
      renderChart([], []);
      renderCumChart([], []);
      return;
    }

    tbody.innerHTML = '';
    const labels = [];
    const values = [];
    const cumValues = [];
    let cum = 0;

    const pref = (window.CurrencyPref && window.CurrencyPref.getMode) ? window.CurrencyPref.getMode() : 'USD';
    const fx = (window.CurrencyPref && window.CurrencyPref.getFx) ? window.CurrencyPref.getFx() : {rate: 0};
    const isKrw = (pref === 'KRW');
    const fxRate = (fx && fx.rate) ? fx.rate : 0;

    for(const r of rows){
      labels.push(r.date);
      const pUsd = parseFloat((''+(r.profit ?? 0)).replace(/,/g,'')) || 0;
      const pDisp = (isKrw && fxRate > 0) ? (pUsd * fxRate) : pUsd;
      values.push(pDisp);
      cum += pDisp;
      cumValues.push(cum);

      const tr = document.createElement('tr');
      const hasDetail = Array.isArray(diaryDetailMap[r.date]) && diaryDetailMap[r.date].length > 0;
      tr.innerHTML = `
        <td>${r.date}</td>
        <td class="text-end">${fmt(r.sell_qty)}</td>
        <td class="text-end">${money(r.buy_amt, 2)}</td>
        <td class="text-end">${money(r.sell_amt, 2)}</td>
        <td class="text-end ${profitClass(r.profit)}">${money(r.profit, 2)}</td>
        <td class="text-end ${profitClass(r.rate)}">${fmt(r.rate)}%</td>
        <td class="text-end">
          <button class="btn btn-sm btn-outline-light" ${hasDetail ? '' : 'disabled'} onclick="showDiaryDetail('${r.date}')">
            <i class="fas fa-info-circle"></i>
          </button>
        </td>
      `;
      tbody.appendChild(tr);
    }
    renderChart(labels, values);
    renderCumChart(labels, cumValues);
  }

  function showDiaryDetail(date){
    const title = document.getElementById('diaryDetailTitle');
    const body = document.getElementById('diaryDetailBody');
    if(title) title.textContent = `${date} 매매 상세`;
    const rows = (diaryDetailMap[date] || []);
    if(!rows.length){
      body.innerHTML = '<div class="text-muted">상세 내역이 없습니다.</div>';
      new bootstrap.Modal(document.getElementById('diaryDetailModal')).show();
      return;
    }

    const money = (v, digits=2)=>{
      try{
        if(window.CurrencyPref) return window.CurrencyPref.formatMoney(v, 'USD', {digits});
      }catch(e){}
      const x = parseFloat((''+(v ?? '')).replace(/,/g,''));
      if(isNaN(x)) return '-';
      return '$' + x.toLocaleString(undefined,{maximumFractionDigits: digits});
    };
    const num = (v)=> {
      const x = parseFloat((''+(v ?? '')).replace(/,/g,''));
      return isNaN(x) ? 0 : x;
    };

    let totalBuy = 0;
    let totalSell = 0;
    let totalProfit = 0;

    let html = `
      <div class="table-responsive">
        <table class="table table-dark table-hover align-middle mb-0">
          <thead>
            <tr>
              <th>종목명</th>
              <th>코드</th>
              <th>거래소</th>
              <th>구분</th>
              <th class="text-end">수량</th>
              <th class="text-end">매수금액</th>
              <th class="text-end">매도금액</th>
              <th class="text-end">손익</th>
              <th class="text-end">수익률</th>
            </tr>
          </thead>
          <tbody>
    `;

    for(const r of rows){
      const buy = num(r.buy_amt);
      const sell = num(r.sell_amt);
      const profit = num(r.profit);
      totalBuy += buy;
      totalSell += sell;
      totalProfit += profit;
      html += `
        <tr>
          <td>${r.name || '-'}</td>
          <td>${r.symbol || '-'}</td>
          <td>${r.exchange || '-'}</td>
          <td>${r.side || '-'}</td>
          <td class="text-end">${fmt(r.qty)}</td>
          <td class="text-end">${money(buy, 2)}</td>
          <td class="text-end">${money(sell, 2)}</td>
          <td class="text-end ${profitClass(profit)}">${money(profit, 2)}</td>
          <td class="text-end ${profitClass(r.rate)}">${fmt(r.rate)}%</td>
        </tr>
      `;
    }

    html += `
          <tr class="table-secondary">
            <td colspan="5" class="text-end fw-bold">합계</td>
            <td class="text-end fw-bold">${money(totalBuy, 2)}</td>
            <td class="text-end fw-bold">${money(totalSell, 2)}</td>
            <td class="text-end fw-bold ${profitClass(totalProfit)}">${money(totalProfit, 2)}</td>
            <td class="text-end fw-bold">${totalBuy > 0 ? ((totalProfit / totalBuy) * 100).toFixed(2) : 0}%</td>
          </tr>
        </tbody>
      </table>
    </div>
    `;
    body.innerHTML = html;
    new bootstrap.Modal(document.getElementById('diaryDetailModal')).show();
  }

  function loadDiary(){
    const from = document.getElementById('diary-from').value;
    const to = document.getElementById('diary-to').value;
    const exchange = document.getElementById('diary-exchange').value;

    const tbody = document.getElementById('diary-tbody');
    tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">로딩 중...</td></tr>';

    fetch('/api/status').then(r=>r.json()).then(st=>{
      const mode = st.status.mode;
      try{
        const note = document.getElementById('diary-mock-note');
        if(note) note.classList.toggle('d-none', mode !== 'mock');
      }catch(e){}
      try{
        if(window.CurrencyPref){
          window.CurrencyPref.storeFxFromBalance(st.balance || {});
          window.CurrencyPref.syncCurrencyUi();
        }
      }catch(e){}
      updateCurrencyLabels();
      const params = new URLSearchParams();
      params.set('mode', mode);
      params.set('from', from);
      params.set('to', to);
      if(exchange) params.set('exchange', exchange);
      return fetch('/api/trading-diary/period-profit?' + params.toString());
    }).then(r=>r.json()).then(resp=>{
      if(!resp.success){
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">조회 실패: '+(resp.message||'')+'</td></tr>';
        return;
      }

      document.getElementById('diary-source').textContent = resp.source || '-';
      document.getElementById('diary-note').textContent = resp.note || '';

      document.getElementById('diary-total-trades').textContent = fmt(resp.summary.total_trades);
      const money = (v, digits=2)=>{
        try{
          if(window.CurrencyPref) return window.CurrencyPref.formatMoney(v, 'USD', {digits});
        }catch(e){}
        const x = parseFloat((''+(v ?? '')).replace(/,/g,''));
        if(isNaN(x)) return '-';
        return '$' + x.toLocaleString(undefined,{maximumFractionDigits: digits});
      };
      const totalProfitEl = document.getElementById('diary-total-profit');
      const totalRateEl = document.getElementById('diary-total-rate');
      totalProfitEl.textContent = money(resp.summary.total_profit, 2);
      totalRateEl.textContent = (resp.summary.total_rate ?? '-') + '%';
      totalProfitEl.className = `fs-4 fw-bold ${profitClass(resp.summary.total_profit)}`;
      totalRateEl.className = `fs-4 fw-bold ${profitClass(resp.summary.total_rate)}`;

      const rows = resp.rows || [];
      diaryRowsAll = rows;
      setDetailRows(resp.detail_rows || []);
      applyDiaryFilter();
    }).catch(err=>{
      tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">오류: '+err+'</td></tr>';
    });
  }

  document.getElementById('btn-diary-search').addEventListener('click', loadDiary);
  document.getElementById('btn-diary-refresh').addEventListener('click', loadDiary);
  document.getElementById('diary-profit-filter').addEventListener('change', applyDiaryFilter);
  document.getElementById('diary-chart-tab').addEventListener('shown.bs.tab', function(){
    try{ if(chart) chart.resize(); }catch(e){}
  });
  document.getElementById('diary-cum-tab').addEventListener('shown.bs.tab', function(){
    try{ if(cumChart) cumChart.resize(); }catch(e){}
  });
  initDates();
  updateCurrencyLabels();
  loadDiary();
  window.addEventListener('currency:changed', ()=>{
    try{ loadDiary(); }catch(e){}
  });
</script>
{% endblock %}


