<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>myKis - í•´ì™¸ì£¼ì‹ ìë™ë§¤ë§¤ ì‹œìŠ¤í…œ</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #1a1d21;
        }
        .card {
            background-color: #212529;
            border: 1px solid #2c3034;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        .navbar {
            background-color: #212529;
            border-bottom: 1px solid #2c3034;
        }
        .log-container {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: 'Consolas', monospace;
            padding: 15px;
            border-radius: 5px;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-size: 0.9rem;
            border: 1px solid #30363d;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark mb-4">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/"><i class="fas fa-robot me-2"></i>myKis</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/"><i class="fas fa-tachometer-alt me-1"></i>ëŒ€ì‹œë³´ë“œ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/portfolio"><i class="fas fa-chart-pie me-1"></i>í¬íŠ¸í´ë¦¬ì˜¤</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/orders"><i class="fas fa-list-alt me-1"></i>ì£¼ë¬¸ë‚´ì—­</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/trading-diary"><i class="fas fa-book me-1"></i>ë§¤ë§¤ì¼ì§€</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/auto-trading"><i class="fas fa-robot me-1"></i>ìë™ë§¤ë§¤</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/api-test"><i class="fas fa-flask me-1"></i>API í…ŒìŠ¤íŠ¸</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/settings"><i class="fas fa-cog me-1"></i>ì‹œìŠ¤í…œì„¤ì •</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <a class="btn btn-sm btn-outline-light me-2" href="/server-selection">
                        <i class="fas fa-server me-1"></i>ì„œë²„ ì„ íƒ
                    </a>
                    <div class="dropdown me-2">
                        <button class="btn btn-secondary dropdown-toggle btn-sm" type="button" id="serverModeBtn" data-bs-toggle="dropdown">
                            <i class="fas fa-server me-1"></i><span id="current-mode-text">Loading...</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end dropdown-menu-dark">
                            <li><h6 class="dropdown-header">ì„œë²„ ì „í™˜ (ì¬ì‹œì‘ í•„ìš”)</h6></li>
                            <li><a class="dropdown-item" href="#" onclick="changeMode('mock')">ğŸŸ¢ ëª¨ì˜íˆ¬ì (Mock)</a></li>
                            <li><a class="dropdown-item" href="#" onclick="changeMode('real')">ğŸ”´ ì‹¤ì „íˆ¬ì (Real)</a></li>
                        </ul>
                    </div>
                    <div class="btn-group me-2" role="group" aria-label="currency-toggle">
                        <button type="button" class="btn btn-sm btn-outline-light" id="btn-currency-usd">USD</button>
                        <button type="button" class="btn btn-sm btn-outline-light" id="btn-currency-krw">KRW</button>
                    </div>
                    <div class="small text-muted me-2" id="currency-fx-text" style="min-width: 180px;"></div>
                    <button class="btn btn-sm btn-outline-success" onclick="openTradePreview()"><i class="fas fa-play me-1"></i>ì¦‰ì‹œ ì‹¤í–‰</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-4">
        {% block content %}{% endblock %}
    </div>

    <!-- ì¦‰ì‹œ ì‹¤í–‰: ë¯¸ë¦¬ë³´ê¸° ëª¨ë‹¬ (autokiwoomstock ìŠ¤íƒ€ì¼) -->
    <div class="modal fade" id="tradePreviewModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-dark border-secondary">
          <div class="modal-header border-secondary">
            <h5 class="modal-title"><i class="fas fa-play me-2"></i>ì¦‰ì‹œ ì‹¤í–‰ - ë¯¸ë¦¬ë³´ê¸°</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="small text-muted mb-3">
              ë¶„ì„ ê²°ê³¼ë¥¼ ë¨¼ì € í™•ì¸í•˜ê³ , <strong>í™•ì¸ í›„ ì‹¤í–‰</strong>ì„ ëˆŒëŸ¬ì•¼ ì‹¤ì œ ì£¼ë¬¸ì´ ë‚˜ê°‘ë‹ˆë‹¤.
            </div>

            <div class="row g-3 mb-3">
              <div class="col-md-6">
                <div class="card bg-dark border-secondary">
                  <div class="card-header border-secondary"><strong>ë¶„ì„ ì •ë³´</strong></div>
                  <div class="card-body small">
                    <div>ë¶„ì„ ë‚ ì§œ: <span id="preview-analysis-date">-</span></div>
                    <div>ì´ ì¢…ëª© ìˆ˜: <span id="preview-total-stocks">-</span></div>
                    <div>ë§¤ë„ ëŒ€ìƒ: <span id="preview-sell-count">-</span></div>
                    <div>ë§¤ìˆ˜ ëŒ€ìƒ: <span id="preview-buy-count">-</span></div>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card bg-dark border-secondary">
                  <div class="card-header border-secondary"><strong>ì˜ˆì‚°/ì „ëµ</strong></div>
                  <div class="card-body small">
                    <div>ì£¼ë¬¸ê°€ëŠ¥(USD): <span id="preview-orderable-usd">-</span> <span class="text-muted" id="preview-orderable-src"></span></div>
                    <div>ë§¤ìˆ˜ ì œì™¸(USD): <span id="preview-reserve-usd">-</span></div>
                    <div>ì´ ì˜ˆì‚°(USD): <span id="preview-total-budget-usd">-</span></div>
                    <div>ì¢…ëª©ë‹¹ ì˜ˆì‚°(USD): <span id="preview-per-stock-usd">-</span></div>
                    <div class="mt-2" id="preview-fx-warning"></div>
                    <div class="text-muted">ì†ì ˆ/ìµì ˆ/ìµœëŒ€ë³´ìœ  ê¸°ì¤€ì„ ë°˜ì˜í•´ ë§¤ë„ í›„ë³´ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mb-3">
              <h6 class="mb-2"><i class="fas fa-arrow-down me-2"></i>ë§¤ë„ ëŒ€ìƒ</h6>
              <div class="table-responsive">
                <table class="table table-sm table-dark table-hover align-middle">
                  <thead class="table-danger">
                    <tr>
                      <th>ì¢…ëª©ëª…</th>
                      <th>ì½”ë“œ</th>
                      <th class="text-end">ë³´ìœ ìˆ˜ëŸ‰</th>
                      <th class="text-end">í‰ê· ë‹¨ê°€</th>
                      <th class="text-end">í˜„ì¬ê°€</th>
                      <th class="text-end">ìˆ˜ìµë¥ </th>
                      <th class="text-end">ë³´ìœ ê¸°ê°„</th>
                      <th>ë§¤ë„ì‚¬ìœ </th>
                    </tr>
                  </thead>
                  <tbody id="preview-sell-tbody">
                    <tr><td colspan="8" class="text-center text-muted">ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="mb-2">
              <h6 class="mb-2"><i class="fas fa-arrow-up me-2"></i>ë§¤ìˆ˜ ëŒ€ìƒ</h6>
              <div class="table-responsive">
                <table class="table table-sm table-dark table-hover align-middle">
                  <thead class="table-success">
                    <tr>
                      <th class="text-end">ìˆœìœ„</th>
                      <th>ì¢…ëª©ëª…</th>
                      <th>ì½”ë“œ</th>
                      <th>ê±°ë˜ì†Œ</th>
                      <th class="text-end">í˜„ì¬ê°€</th>
                      <th class="text-end">ì˜ˆìƒìˆ˜ëŸ‰</th>
                      <th class="text-end">ì˜ˆìƒê¸ˆì•¡</th>
                      <th>ì„¤ëª…</th>
                    </tr>
                  </thead>
                  <tbody id="preview-buy-tbody">
                    <tr><td colspan="8" class="text-center text-muted">ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div class="small text-muted" id="preview-meta">-</div>
          </div>
          <div class="modal-footer border-secondary">
            <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">ë‹«ê¸°</button>
            <button type="button" class="btn btn-success" id="btn-preview-execute">
              <i class="fas fa-check me-1"></i>í™•ì¸ í›„ ì‹¤í–‰
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // ===== Navbar active highlight (current page) =====
        (function(){
            function _normPath(p){
                try{
                    if(!p) return '/';
                    // strip query/hash if accidentally included
                    p = String(p).split('?')[0].split('#')[0];
                    // normalize trailing slash (except root)
                    if(p.length > 1 && p.endsWith('/')) p = p.slice(0, -1);
                    return p || '/';
                }catch(e){
                    return '/';
                }
            }

            function _hrefPath(href){
                try{
                    // allow absolute/relative href
                    const u = new URL(href, window.location.origin);
                    return _normPath(u.pathname);
                }catch(e){
                    return null;
                }
            }

            function _markActiveNav(){
                const cur = _normPath(window.location.pathname);
                const links = Array.from(document.querySelectorAll('.navbar-nav .nav-link[href]'));
                if(!links.length) return;

                // choose best match: exact > prefix (longest)
                let best = null;
                let bestLen = -1;
                for(const a of links){
                    const p = _hrefPath(a.getAttribute('href'));
                    if(!p) continue;

                    if(cur === p){
                        best = a; bestLen = p.length;
                        break; // exact match is best possible
                    }

                    // root should only match root
                    if(p === '/') continue;

                    if(cur.startsWith(p)){
                        // boundary check: "/orders" should match "/orders" or "/orders/xxx" but not "/orders2"
                        const next = cur.charAt(p.length);
                        const okBoundary = (next === '' || next === '/');
                        if(okBoundary && p.length > bestLen){
                            best = a;
                            bestLen = p.length;
                        }
                    }
                }

                // clear old states
                for(const a of links){
                    a.classList.remove('active');
                    a.removeAttribute('aria-current');
                }

                // special-case root dashboard
                if(!best && cur === '/'){
                    best = links.find(x => _hrefPath(x.getAttribute('href')) === '/') || null;
                }

                if(best){
                    best.classList.add('active');
                    best.setAttribute('aria-current', 'page');
                }
            }

            document.addEventListener('DOMContentLoaded', _markActiveNav);
        })();

        // ===== Currency preference (USD/KRW) =====
        (function(){
            const KEY_MODE = 'currency_mode';
            const KEY_RATE = 'usd_krw_rate';
            const KEY_SRC = 'usd_krw_rate_source';
            const KEY_AT = 'usd_krw_rate_updated_at';

            function getMode(){
                return (localStorage.getItem(KEY_MODE) || 'USD').toUpperCase();
            }
            function setMode(m){
                localStorage.setItem(KEY_MODE, (m || 'USD').toUpperCase());
            }
            function getFx(){
                const r = parseFloat(localStorage.getItem(KEY_RATE) || '0');
                const src = localStorage.getItem(KEY_SRC) || '';
                const at = localStorage.getItem(KEY_AT) || '';
                return { rate: (isNaN(r) ? 0 : r), source: src, updated_at: at };
            }
            function storeFxFromBalance(balance){
                try{
                    if(!balance) return;
                    const r = parseFloat(balance.usd_krw_rate ?? 0);
                    if(!isNaN(r) && r > 0){
                        localStorage.setItem(KEY_RATE, String(r));
                        localStorage.setItem(KEY_SRC, String(balance.usd_krw_rate_source || ''));
                        localStorage.setItem(KEY_AT, new Date().toISOString());
                    }
                }catch(e){}
            }
            function _fmtNum(n, digits){
                try{
                    const x = parseFloat((''+n).replace(/,/g,''));
                    if(isNaN(x)) return null;
                    return x.toLocaleString(undefined, { maximumFractionDigits: digits });
                }catch(e){ return null; }
            }
            function formatMoney(val, baseCurrency, opts){
                // baseCurrency: 'USD' or 'KRW'
                const mode = getMode();
                const fx = getFx();
                const base = (baseCurrency || 'USD').toUpperCase();
                const digits = (opts && typeof opts.digits === 'number') ? opts.digits : (mode === 'KRW' ? 0 : 2);

                const raw = parseFloat((''+(val ?? '')).replace(/,/g,''));
                if(isNaN(raw)) return '-';

                let out = raw;
                if(mode !== base){
                    if(fx.rate <= 0) return '-';
                    out = (base === 'USD' && mode === 'KRW') ? (raw * fx.rate) : (raw / fx.rate);
                }
                const s = _fmtNum(out, digits);
                if(s === null) return '-';
                return (mode === 'KRW') ? ('â‚©' + s) : ('$' + s);
            }

            function syncCurrencyUi(){
                const mode = getMode();
                const fx = getFx();
                const usdBtn = document.getElementById('btn-currency-usd');
                const krwBtn = document.getElementById('btn-currency-krw');
                const fxText = document.getElementById('currency-fx-text');

                if(usdBtn && krwBtn){
                    usdBtn.classList.toggle('btn-light', mode === 'USD');
                    usdBtn.classList.toggle('btn-outline-light', mode !== 'USD');
                    krwBtn.classList.toggle('btn-light', mode === 'KRW');
                    krwBtn.classList.toggle('btn-outline-light', mode !== 'KRW');
                }
                if(fxText){
                    if(fx.rate > 0){
                        fxText.textContent = `í™˜ìœ¨: ${fx.rate.toLocaleString()}ì›/$ (${fx.source || '-'})`;
                    }else{
                        fxText.textContent = 'í™˜ìœ¨: -';
                    }
                }
                // í™˜ìœ¨ì´ ì—†ìœ¼ë©´ KRW ëª¨ë“œ ê°•ì œ ë°©ì§€
                if(mode === 'KRW' && fx.rate <= 0){
                    setMode('USD');
                    if(fxText) fxText.textContent = 'í™˜ìœ¨ ë¯¸í™•ì¸: USDë¡œ í‘œì‹œí•©ë‹ˆë‹¤.';
                }
            }

            window.CurrencyPref = {
                getMode,
                setMode,
                getFx,
                storeFxFromBalance,
                formatMoney,
                syncCurrencyUi,
            };

            document.addEventListener('DOMContentLoaded', ()=>{
                const usdBtn = document.getElementById('btn-currency-usd');
                const krwBtn = document.getElementById('btn-currency-krw');
                if(usdBtn) usdBtn.addEventListener('click', ()=>{
                    setMode('USD'); syncCurrencyUi(); window.dispatchEvent(new Event('currency:changed'));
                });
                if(krwBtn) krwBtn.addEventListener('click', ()=>{
                    setMode('KRW'); syncCurrencyUi(); window.dispatchEvent(new Event('currency:changed'));
                });
                syncCurrencyUi();
            });
        })();

        let _lastPreviewId = null;
        let _previewPollTimer = null;
        let _previewPollStartedAt = null;

        function _stopPreviewPolling(){
            if(_previewPollTimer){
                clearInterval(_previewPollTimer);
                _previewPollTimer = null;
            }
        }

        function _startPreviewPolling(previewId){
            _stopPreviewPolling();
            _previewPollStartedAt = Date.now();
            _previewPollTimer = setInterval(()=>{
                // ìµœëŒ€ 20ë¶„ í´ë§ (ì‹¤ì‹œê°„ ë¶„ì„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŒ)
                if(Date.now() - _previewPollStartedAt > 20 * 60 * 1000){
                    _stopPreviewPolling();
                    document.getElementById('preview-meta').textContent = 'ë¯¸ë¦¬ë³´ê¸° íƒ€ì„ì•„ì›ƒ: ë¶„ì„ì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë¦½ë‹ˆë‹¤. (20ë¶„)';
                    return;
                }

                fetch(`/api/trade/preview/${encodeURIComponent(previewId)}`, { method: 'GET' })
                  .then(r=>r.json())
                  .then(resp=>{
                    if(!resp.success){
                      _stopPreviewPolling();
                      document.getElementById('preview-sell-tbody').innerHTML = '<tr><td colspan="8" class="text-center text-muted">-</td></tr>';
                      document.getElementById('preview-buy-tbody').innerHTML = '<tr><td colspan="8" class="text-center text-muted">-</td></tr>';
                      document.getElementById('preview-meta').textContent = 'ë¯¸ë¦¬ë³´ê¸° ì¡°íšŒ ì‹¤íŒ¨: ' + (resp.message||'');
                      return;
                    }

                    const status = resp.status || 'running';
                    if(status === 'running'){
                      document.getElementById('preview-meta').textContent =
                        `ë¶„ì„ ì‹¤í–‰ ì¤‘... (mode=${resp.mode}) / created_at=${resp.created_at} / expires_at=${resp.expires_at}`;
                      return;
                    }

                    if(status === 'error'){
                      _stopPreviewPolling();
                      document.getElementById('preview-sell-tbody').innerHTML = '<tr><td colspan="8" class="text-center text-muted">-</td></tr>';
                      document.getElementById('preview-buy-tbody').innerHTML = '<tr><td colspan="8" class="text-center text-muted">-</td></tr>';
                      document.getElementById('preview-meta').textContent = 'ë¯¸ë¦¬ë³´ê¸° ì˜¤ë¥˜: ' + (resp.error||'unknown');
                      return;
                    }

                    function _renderPreviewView(view){
                      const fmt = (n, digits=2)=>{
                        try{
                          const x = parseFloat(n);
                          if(isNaN(x)) return '-';
                          return x.toLocaleString(undefined, {maximumFractionDigits: digits});
                        }catch(e){ return '-'; }
                      };

                      // ìš”ì•½
                      const a = (view && view.analysis) ? view.analysis : {};
                      const b = (view && view.budget) ? view.budget : {};
                      const st = (view && view.strategy) ? view.strategy : {};
                      document.getElementById('preview-analysis-date').textContent = a.analysis_date || '-';
                      document.getElementById('preview-total-stocks').textContent = (a.total_stocks ?? '-') || '-';
                      document.getElementById('preview-orderable-usd').textContent = '$' + fmt(b.orderable_usd, 2);
                      document.getElementById('preview-orderable-src').textContent = b.orderable_source ? `(${b.orderable_source})` : '';
                      document.getElementById('preview-reserve-usd').textContent = '$' + fmt(st.reserve_cash_usd, 2);
                      document.getElementById('preview-total-budget-usd').textContent = '$' + fmt(b.total_budget_usd, 2);
                      document.getElementById('preview-per-stock-usd').textContent = '$' + fmt(b.per_stock_budget_usd, 2);

                      // í™˜ìœ¨ ì¡°íšŒ ì‹¤íŒ¨ ì‹œ: ë§¤ìˆ˜ ìŠ¤í‚µ(ë§¤ë„ë§Œ ì‹¤í–‰) ê²½ê³  ë°°ì§€
                      try{
                        const fxRate = parseFloat(b.usd_krw_rate ?? st.usd_krw_rate ?? 0);
                        const fxSrc = (b.usd_krw_rate_source ?? st.usd_krw_rate_source ?? '');
                        const warnEl = document.getElementById('preview-fx-warning');
                        if(!warnEl) return;
                        if(!fxRate || isNaN(fxRate) || fxRate <= 0){
                          warnEl.innerHTML =
                            `<span class="badge bg-warning text-dark me-2">ë§¤ìˆ˜ ìŠ¤í‚µ</span>` +
                            `<span class="text-warning">í™˜ìœ¨ ìë™ì¡°íšŒ ì‹¤íŒ¨ë¡œ ì´ë²ˆ ì‹¤í–‰ì€ <strong>ë§¤ë„ë§Œ</strong> ì§„í–‰ë©ë‹ˆë‹¤.</span>` +
                            (fxSrc ? ` <span class="text-muted">(fx_source=${fxSrc})</span>` : ``);
                        }else{
                          warnEl.innerHTML =
                            `<span class="badge bg-secondary me-2">í™˜ìœ¨</span>` +
                            `<span class="text-muted">${fxRate.toLocaleString()}ì›/ë‹¬ëŸ¬</span>` +
                            (fxSrc ? ` <span class="text-muted">(fx_source=${fxSrc})</span>` : ``);
                        }
                      }catch(e){
                        const warnEl = document.getElementById('preview-fx-warning');
                        if(warnEl) warnEl.innerHTML = '';
                      }

                      const sells = (view && view.sell_candidates) ? view.sell_candidates : [];
                      const buys = (view && view.buy_candidates) ? view.buy_candidates : [];
                      document.getElementById('preview-sell-count').textContent = (sells && sells.length) ? sells.length : 0;
                      document.getElementById('preview-buy-count').textContent = (buys && buys.length) ? buys.length : 0;

                      // Sell table
                      const sellTbody = document.getElementById('preview-sell-tbody');
                      sellTbody.innerHTML = '';
                      if(!sells || sells.length === 0){
                        sellTbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">ë§¤ë„ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                      }else{
                        sells.forEach(it=>{
                          const pr = parseFloat(it.profit_rate ?? 0);
                          const prClass = pr > 0 ? 'text-danger' : (pr < 0 ? 'text-primary' : 'text-white');
                          const hd = (it.holding_days === null || it.holding_days === undefined) ? '-' : (it.holding_days + 'd');
                          const reasons = (it.reasons || []).join(', ');
                          sellTbody.insertAdjacentHTML('beforeend', `
                            <tr>
                              <td>${it.name || it.code || '-'}</td>
                              <td>${it.code || '-'}</td>
                              <td class="text-end">${fmt(it.qty, 4)}</td>
                              <td class="text-end">${fmt(it.avg_price, 4)}</td>
                              <td class="text-end">${it.current_price ? fmt(it.current_price, 4) : '-'}</td>
                              <td class="text-end ${prClass}">${fmt(pr, 2)}%</td>
                              <td class="text-end">${hd}</td>
                              <td>${reasons || '-'}</td>
                            </tr>
                          `);
                        });
                      }

                      // Buy table
                      const buyTbody = document.getElementById('preview-buy-tbody');
                      buyTbody.innerHTML = '';
                      if(!buys || buys.length === 0){
                        buyTbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">ë§¤ìˆ˜ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                      }else{
                        buys.forEach(it=>{
                          buyTbody.insertAdjacentHTML('beforeend', `
                            <tr>
                              <td class="text-end">${it.rank ?? '-'}</td>
                              <td>${it.name || it.code || '-'}</td>
                              <td>${it.code || '-'}</td>
                              <td>${it.exchange || '-'}</td>
                              <td class="text-end">${it.current_price ? fmt(it.current_price, 4) : '-'}</td>
                              <td class="text-end">${(it.est_qty ?? 0).toLocaleString()}</td>
                              <td class="text-end">${it.est_amount ? ('$' + fmt(it.est_amount, 2)) : '-'}</td>
                              <td>${it.reason || '-'}</td>
                            </tr>
                          `);
                        });
                      }
                    }

                    if(status === 'ready'){
                      _stopPreviewPolling();
                      if(resp.view){
                        _renderPreviewView(resp.view);
                      }else{
                        // fallback: ê¸°ì¡´ JSON í‘œì‹œ
                        const a = resp.analysis || {};
                        document.getElementById('preview-sell-tbody').innerHTML = '<tr><td colspan="8" class="text-center text-muted">-</td></tr>';
                        document.getElementById('preview-buy-tbody').innerHTML = '<tr><td colspan="8" class="text-center text-muted">-</td></tr>';
                        document.getElementById('preview-analysis-date').textContent = '-';
                        document.getElementById('preview-total-stocks').textContent = '-';
                        document.getElementById('preview-sell-count').textContent = (a.sell || []).length || 0;
                        document.getElementById('preview-buy-count').textContent = (a.buy || []).length || 0;
                      }
                      document.getElementById('preview-meta').textContent =
                        `ì™„ë£Œ (mode=${resp.mode}) / created_at=${resp.created_at} / expires_at=${resp.expires_at}`;
                      return;
                    }
                  })
                  .catch(err=>{
                    // ë„¤íŠ¸ì›Œí¬ ìˆœê°„ ì˜¤ë¥˜ëŠ” ê³„ì† í´ë§
                    document.getElementById('preview-meta').textContent = 'ë¯¸ë¦¬ë³´ê¸° í´ë§ ì˜¤ë¥˜(ì¬ì‹œë„): ' + err;
                  });
            }, 2000);
        }

        function openTradePreview(){
            _lastPreviewId = null;
            _stopPreviewPolling();
            // ì´ˆê¸°í™”
            document.getElementById('preview-analysis-date').textContent = '-';
            document.getElementById('preview-total-stocks').textContent = '-';
            document.getElementById('preview-sell-count').textContent = '-';
            document.getElementById('preview-buy-count').textContent = '-';
            document.getElementById('preview-orderable-usd').textContent = '-';
            document.getElementById('preview-orderable-src').textContent = '';
            document.getElementById('preview-reserve-usd').textContent = '-';
            document.getElementById('preview-total-budget-usd').textContent = '-';
            document.getElementById('preview-per-stock-usd').textContent = '-';
            document.getElementById('preview-fx-warning').innerHTML = '';
            document.getElementById('preview-sell-tbody').innerHTML = '<tr><td colspan="8" class="text-center text-muted">ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';
            document.getElementById('preview-buy-tbody').innerHTML = '<tr><td colspan="8" class="text-center text-muted">ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>';
            document.getElementById('preview-meta').textContent = '';

            const modal = new bootstrap.Modal(document.getElementById('tradePreviewModal'));
            modal.show();

            fetch('/api/trade/preview', { method: 'POST' })
              .then(r=>r.json())
              .then(resp=>{
                if(!resp.success){
                  document.getElementById('preview-sell-tbody').innerHTML = '<tr><td colspan="8" class="text-center text-muted">-</td></tr>';
                  document.getElementById('preview-buy-tbody').innerHTML = '<tr><td colspan="8" class="text-center text-muted">-</td></tr>';
                  document.getElementById('preview-meta').textContent = 'ë¯¸ë¦¬ë³´ê¸° ì‹¤íŒ¨: ' + (resp.message||'');
                  return;
                }
                _lastPreviewId = resp.preview_id;
                document.getElementById('preview-meta').textContent =
                  `ë¶„ì„ ìš”ì²­ ì ‘ìˆ˜ë¨. ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘... (mode=${resp.mode}) / created_at=${resp.created_at} / expires_at=${resp.expires_at}`;
                _startPreviewPolling(_lastPreviewId);
              })
              .catch(err=>{
                document.getElementById('preview-meta').textContent = 'ë¯¸ë¦¬ë³´ê¸° ì˜¤ë¥˜: ' + err;
              });
        }

        document.getElementById('btn-preview-execute').addEventListener('click', function(){
            if(!_lastPreviewId){
                alert('ë¯¸ë¦¬ë³´ê¸° ë°ì´í„°ë¥¼ ì•„ì§ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                return;
            }
            if(!confirm('ë¯¸ë¦¬ë³´ê¸° ê²°ê³¼ëŒ€ë¡œ ìë™ë§¤ë§¤ë¥¼ 1íšŒ ì‹¤í–‰í• ê¹Œìš”?')) return;
            fetch('/api/trade/execute', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({preview_id: _lastPreviewId})
            }).then(r=>r.json()).then(resp=>{
                if(resp.success){
                    alert(resp.message || 'ì‹¤í–‰ ì‹œì‘');
                }else{
                    alert('ì‹¤í–‰ ì‹¤íŒ¨: ' + (resp.message || 'unknown'));
                }
            }).catch(err=>alert('ì‹¤í–‰ ì˜¤ë¥˜: ' + err));
        });

        function changeMode(mode) {
            if(!confirm(mode + " ëª¨ë“œë¡œ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            fetch('/api/settings/mode', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({mode: mode})
            })
            .then(res => res.json())
            .then(data => {
                if(data.result === 'success') {
                    alert("ëª¨ë“œê°€ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
                    location.reload();
                } else {
                    alert("ì „í™˜ ì‹¤íŒ¨: " + data.message);
                }
            });
        }
        
        // í˜„ì¬ ëª¨ë“œ í‘œì‹œ
        $.get('/api/status', function(data) {
            const mode = data.status.mode;
            const text = mode === 'mock' ? 'ëª¨ì˜íˆ¬ì (Mock)' : 'ì‹¤ì „íˆ¬ì (Real)';
            const btnClass = mode === 'mock' ? 'btn-success' : 'btn-danger';
            
            $('#current-mode-text').text(text);
            $('#serverModeBtn').removeClass('btn-secondary').addClass(btnClass);
        });
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
