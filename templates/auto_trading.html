{% extends "base.html" %}

{% block content %}
<div class="card">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-status" type="button" role="tab">
          <i class="fas fa-info-circle me-1"></i>현재 상태
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-settings" type="button" role="tab">
          <i class="fas fa-sliders-h me-1"></i>설정
        </button>
      </li>
    </ul>
  </div>
  <div class="card-body">
    <div class="tab-content">
      <div class="tab-pane fade show active" id="tab-status" role="tabpanel">
        <div class="row g-3">
          <div class="col-lg-6">
            <div class="card bg-dark border-secondary">
              <div class="card-header border-secondary"><strong>상태</strong></div>
              <div class="card-body">
                <div class="mb-2">
                  자동매매 활성화:
                  <span class="badge bg-secondary" id="auto-enabled-badge">확인 중...</span>
                </div>
                <div class="mb-2">
                  장중 손절 감시:
                  <span class="badge bg-secondary" id="intraday-enabled-badge">확인 중...</span>
                  <span class="text-muted small ms-2" id="intraday-threshold-text"></span>
                </div>
                <div class="text-muted" id="status-box">로딩 중...</div>
                <hr class="border-secondary" />
                <div class="small text-muted" id="status-detail"></div>
                <div class="mt-3">
                  <button class="btn btn-outline-success" id="run-once-btn">
                    <i class="fas fa-play me-1"></i>즉시 실행(미리보기 후)
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card bg-dark border-secondary">
              <div class="card-header border-secondary"><strong>안내</strong></div>
              <div class="card-body text-muted">
                - 즉시 실행은 분석서버 결과를 먼저 보여주고 확인 후 실행합니다.<br/>
                - 자동매매는 1분 주기 스케줄러로 동작하며, 활성화가 ON일 때만 실행됩니다.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="tab-settings" role="tabpanel">
        <div class="row g-3">
          <div class="col-lg-8">
            <div class="card bg-dark border-secondary">
              <div class="card-header border-secondary"><strong>자동매매 설정</strong></div>
              <div class="card-body">
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" id="auto-enabled">
                  <label class="form-check-label" for="auto-enabled">자동매매 활성화</label>
                </div>
                <div class="card bg-dark border-secondary mb-3">
                  <div class="card-header border-secondary"><strong>실행 시간(1일 1회)</strong></div>
                  <div class="card-body">
                    <div class="row g-2 align-items-end">
                      <div class="col-md-6">
                        <label class="form-label">실행 시각(HH:MM)</label>
                        <input type="time" class="form-control form-control-sm" id="schedule-time" />
                        <div class="form-text text-muted">자동매매 ON일 때, 1분 주기 체크로 해당 시각에만 1일 1회 실행됩니다.</div>
                      </div>
                      <div class="col-md-6">
                        <div class="text-muted small" id="next-schedule-text">다음 실행시간 계산 중...</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row g-2 mb-3">
                  <div class="col-12">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="analysis-mock-enabled">
                      <label class="form-check-label" for="analysis-mock-enabled">분석 서버 Mock 모드</label>
                    </div>
                  </div>
                  <div class="col-md-8">
                    <label class="form-label">분석 서버 Host</label>
                    <input class="form-control form-control-sm" id="analysis-host" placeholder="localhost" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Port</label>
                    <input type="number" class="form-control form-control-sm" id="analysis-port" placeholder="5000" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">환율(원/달러)</label>
                    <div class="small text-muted" id="usd-krw-auto-text">자동 환율을 불러오는 중...</div>
                    <div class="form-text text-muted">
                      환율은 사용자 입력을 받지 않습니다. KIS API → FinanceDataReader 순으로 자동 조회하며,
                      둘 다 실패하면 <strong>매수는 취소(스킵)</strong>되고 매도 조건만 실행됩니다.
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="small text-muted">분석 요청은 내부에서 실시간 분석 실행 후 결과를 폴링합니다. (<code>/api/start_analysis</code> → <code>/v1/analysis/result</code>)</div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">매수 제외 예수금(원화)</label>
                    <input type="number" class="form-control form-control-sm" id="reserve-cash" />
                    <div class="form-text text-muted">총자산이 커도, 해외주식 매수는 주문가능금액(USD) 기준입니다. 여기 입력한 원화는 환율로 USD로 환산되어 예산에서 제외됩니다.</div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">매수 종목 수(top_n)</label>
                    <input type="number" class="form-control form-control-sm" id="top-n" />
                    <div class="form-text text-muted">분석 서버 BUY 리스트 상위 N개만 매수합니다.</div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">익절(%)</label>
                    <input type="number" step="0.1" class="form-control form-control-sm" id="take-profit" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">손절(%)</label>
                    <input type="number" step="0.1" class="form-control form-control-sm" id="stop-loss" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">최대 보유(일)</label>
                    <input type="number" class="form-control form-control-sm" id="max-hold-days" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">슬리피지(%)</label>
                    <input type="number" step="0.1" class="form-control form-control-sm" id="slippage-pct" />
                  </div>
                  <div class="col-12"><hr class="border-secondary my-2"/></div>
                  <div class="col-md-6">
                    <label class="form-label">매수 주문 방식</label>
                    <select class="form-select form-select-sm" id="buy-order-method">
                      <option value="limit_ask_ladder">매도호가 기반 지정가(1호가→상향 재시도, 실전 추천)</option>
                      <option value="limit_slippage">현재가 + 슬리피지 지정가(기본/모의 권장)</option>
                    </select>
                    <div class="form-text text-muted">
                      해외주식 호가 API(해외주식-033)는 <strong>모의투자 미지원</strong>이라, 모의에서는 지정가(슬리피지) 방식으로 동작합니다.
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">가드: 허용 프리미엄(%)</label>
                    <input type="number" step="0.1" class="form-control form-control-sm" id="limit-buy-max-premium-pct" />
                    <div class="form-text text-muted">현재가 대비 매도호가가 이 %를 초과하면 매수를 스킵합니다.</div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">최대 호가 단계</label>
                    <input type="number" class="form-control form-control-sm" id="limit-buy-max-levels" />
                    <div class="form-text text-muted">미국은 최대 10호가. (예: 5 → 1~5호가까지만 시도)</div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">단계 대기(초)</label>
                    <input type="number" step="0.1" class="form-control form-control-sm" id="limit-buy-step-wait-sec" />
                    <div class="form-text text-muted">주문 후 미체결 확인까지 기다릴 시간입니다.</div>
                  </div>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-primary" id="save-btn">
                    <i class="fas fa-save me-1"></i>저장
                  </button>
                </div>
                <div class="form-text mt-2">
                  자동매매 활성화/전략은 <strong>저장 버튼</strong>을 눌렀을 때만 반영됩니다.
                </div>
              </div>
            </div>

            <div class="card bg-dark border-secondary mt-3">
              <div class="card-header border-secondary">
                <strong>장중 손절 감시 설정</strong>
                <small class="text-muted ms-2">(자동매매와 별개)</small>
              </div>
              <div class="card-body">
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" id="intraday-enabled">
                  <label class="form-check-label" for="intraday-enabled">장중 손절 감시 활성화</label>
                </div>
                <div class="row g-2">
                  <div class="col-md-6">
                    <label class="form-label">기준(%)</label>
                    <input type="number" step="0.1" class="form-control form-control-sm" id="intraday-threshold-pct" />
                    <div class="form-text text-muted">예: <strong>-7</strong> 입력 → -7% 손절 감시 / <strong>+7</strong> 입력 → +7% 익절 감시</div>
                  </div>
                  <div class="col-12">
                    <div class="d-flex align-items-center gap-2 mt-2">
                      <button type="button" class="btn btn-sm btn-primary" id="intraday-save-btn">
                        <i class="fas fa-save me-1"></i>저장(공통)
                      </button>
                      <div class="small text-muted">장중 손절 감시 설정도 위의 <strong>저장</strong> 버튼과 함께 저장됩니다.</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card bg-dark border-secondary">
              <div class="card-header border-secondary"><strong>주의</strong></div>
              <div class="card-body text-muted">
                - 실전 모드에서는 실제 주문이 나갑니다.<br/>
                - 분석 서버가 없으면 Mock 모드를 켜고 테스트하세요.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function loadStrategy(){
    return fetch('/api/status').then(r=>r.json()).then(d=>{
      const mode = d.status.mode;
      return fetch('/api/auto-trading/strategy?mode='+mode).then(r=>r.json()).then(s=>{
        if(!s.success) return;
        // UI 동기화: 현재 설정값(auto_trading_enabled)을 스위치에 반영
        // (주기적으로 갱신되는 loadStatus()에서 체크박스를 건드리면 사용자의 "저장 전 변경"이 덮일 수 있어,
        //  초기 로드(loadStrategy)에서만 반영한다.)
        const autoEl = document.getElementById('auto-enabled');
        if(autoEl) autoEl.checked = !!s.auto_trading_enabled;
        document.getElementById('analysis-mock-enabled').checked = !!s.common.analysis_mock_enabled;
        document.getElementById('analysis-host').value = s.common.analysis_host || 'localhost';
        document.getElementById('analysis-port').value = s.common.analysis_port || 5000;

        // 자동 환율 표시: /api/status.balance.usd_krw_rate
        try{
          const bal = (d && d.balance) ? d.balance : {};
          const r = bal.usd_krw_rate;
          const src = bal.usd_krw_rate_source;
          if(r && parseFloat(r) > 0){
            document.getElementById('usd-krw-auto-text').textContent = `자동 환율: ${parseFloat(r).toLocaleString()}원 (source=${src || '-'})`;
          }else{
            document.getElementById('usd-krw-auto-text').textContent = `자동 환율: - (source=${src || 'unavailable'})`;
          }
        }catch(e){
          document.getElementById('usd-krw-auto-text').textContent = '자동 환율: -';
        }
        document.getElementById('reserve-cash').value = s.strategy.reserve_cash_krw ?? '';
        document.getElementById('top-n').value = (s.strategy.top_n ?? 5) ?? 5;
        document.getElementById('take-profit').value = s.strategy.take_profit_pct ?? '';
        document.getElementById('stop-loss').value = s.strategy.stop_loss_pct ?? '';
        document.getElementById('max-hold-days').value = (s.strategy.max_hold_days ?? s.strategy.max_hold_period ?? '') ?? '';
        document.getElementById('slippage-pct').value = s.strategy.slippage_pct ?? 0.5;

        // 매수 방식/가드
        const defaultBuyMethod = (mode === 'real') ? 'limit_ask_ladder' : 'limit_slippage';
        document.getElementById('buy-order-method').value = (s.strategy.buy_order_method || defaultBuyMethod);
        document.getElementById('limit-buy-max-premium-pct').value = (s.strategy.limit_buy_max_premium_pct ?? 1.0);
        document.getElementById('limit-buy-max-levels').value = (s.strategy.limit_buy_max_levels ?? 5);
        document.getElementById('limit-buy-step-wait-sec').value = (s.strategy.limit_buy_step_wait_sec ?? 1.0);

        const intraday = s.intraday_stop_loss || {};
        document.getElementById('intraday-enabled').checked = !!intraday.enabled;
        const thr = (intraday.threshold_pct ?? (intraday.stop_loss_pct ? -Math.abs(intraday.stop_loss_pct) : -7.0));
        document.getElementById('intraday-threshold-pct').value = parseFloat(thr);

        const sch = s.schedule || {};
        document.getElementById('schedule-time').value = (sch.schedule_time || '22:30').slice(0,5);
        updateNextScheduleText();
      });
    });
  }

  function updateNextScheduleText(){
    const t = document.getElementById('schedule-time').value || '00:00';
    const [hh, mm] = t.split(':').map(x=>parseInt(x,10));
    const now = new Date();
    let next = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
    if(next <= now) next.setDate(next.getDate()+1);
    const pad = (n)=>(''+n).padStart(2,'0');
    document.getElementById('next-schedule-text').textContent =
      `다음 실행: ${next.getFullYear()}-${pad(next.getMonth()+1)}-${pad(next.getDate())} ${pad(next.getHours())}:${pad(next.getMinutes())}`;
  }

  function loadStatus(){
    fetch('/api/status').then(r=>r.json()).then(d=>{
      const mode = d.status.mode;
      fetch('/api/auto-trading/config?mode='+mode).then(r=>r.json()).then(cfg=>{
        document.getElementById('auto-enabled-badge').textContent = cfg.auto_trading_enabled ? 'ON' : 'OFF';
        document.getElementById('auto-enabled-badge').className = 'badge ' + (cfg.auto_trading_enabled ? 'bg-success' : 'bg-secondary');
        document.getElementById('status-box').innerText =
          'mode=' + mode + ', market_open=' + d.status.market_open + ', engine_running=' + d.status.is_running;
        document.getElementById('status-detail').innerText =
          'last_run=' + (d.status.engine_last_run_at || '-') +
          '\nnext_run=' + (d.status.engine_next_run_at || '-') +
          (d.status.engine_last_error ? ('\nlast_error=' + d.status.engine_last_error) : '');
      });

      // 장중 손절 감시 상태는 strategy endpoint에서 가져옴(보안/구조 통일)
      fetch('/api/auto-trading/strategy?mode='+mode).then(r=>r.json()).then(s=>{
        const intraday = (s && s.intraday_stop_loss) ? s.intraday_stop_loss : {};
        const enabled = !!intraday.enabled;
        document.getElementById('intraday-enabled-badge').textContent = enabled ? 'ON' : 'OFF';
        document.getElementById('intraday-enabled-badge').className = 'badge ' + (enabled ? 'bg-danger' : 'bg-secondary');
        const thr = (intraday.threshold_pct ?? (intraday.stop_loss_pct ? -Math.abs(intraday.stop_loss_pct) : -7.0));
        const thrNum = parseFloat(thr);
        const thrText = (thrNum >= 0 ? `+${thrNum}` : `${thrNum}`);
        document.getElementById('intraday-threshold-text').textContent = enabled ? `(기준: ${thrText}%)` : '';
      });
    });
  }

  document.getElementById('save-btn').addEventListener('click', function(){
    fetch('/api/status').then(r=>r.json()).then(d=>{
      const mode = d.status.mode;
      const payload = {
        mode: mode,
        auto_trading_enabled: document.getElementById('auto-enabled').checked,
        schedule: {
          schedule_time: (document.getElementById('schedule-time').value || '00:00').slice(0,5),
        },
        common: {
          analysis_mock_enabled: document.getElementById('analysis-mock-enabled').checked,
          analysis_host: document.getElementById('analysis-host').value.trim(),
          analysis_port: parseInt(document.getElementById('analysis-port').value, 10),
        },
        intraday_stop_loss: {
          enabled: document.getElementById('intraday-enabled').checked,
          threshold_pct: parseFloat(document.getElementById('intraday-threshold-pct').value),
        },
        strategy: {
          reserve_cash_krw: parseFloat(document.getElementById('reserve-cash').value),
          top_n: parseInt(document.getElementById('top-n').value, 10),
          take_profit_pct: parseFloat(document.getElementById('take-profit').value),
          stop_loss_pct: parseFloat(document.getElementById('stop-loss').value),
          max_hold_days: parseInt(document.getElementById('max-hold-days').value, 10),
          slippage_pct: parseFloat(document.getElementById('slippage-pct').value),
          buy_order_method: document.getElementById('buy-order-method').value,
          limit_buy_max_premium_pct: parseFloat(document.getElementById('limit-buy-max-premium-pct').value),
          limit_buy_max_levels: parseInt(document.getElementById('limit-buy-max-levels').value, 10),
          limit_buy_step_wait_sec: parseFloat(document.getElementById('limit-buy-step-wait-sec').value),
        }
      };

      fetch('/api/auto-trading/strategy', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).then(r=>r.json()).then(resp=>{
        if(resp.success) alert('저장 완료');
        else alert('저장 실패: ' + (resp.message || 'unknown'));
        loadStrategy();
        loadStatus();
      });
    });
  });

  // 장중 손절 감시 카드의 저장 버튼은 공통 저장 버튼을 재사용
  document.getElementById('intraday-save-btn').addEventListener('click', function(){
    document.getElementById('save-btn').click();
  });

  document.getElementById('run-once-btn').addEventListener('click', function(){
    // base.html의 미리보기 모달 재사용
    if(typeof openTradePreview === 'function'){
      openTradePreview();
    }else{
      alert('미리보기 기능이 준비되지 않았습니다.');
    }
  });

  loadStrategy();
  loadStatus();
  document.getElementById('schedule-time').addEventListener('change', updateNextScheduleText);
  setInterval(loadStatus, 5000);
</script>
{% endblock %}


