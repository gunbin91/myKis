{% extends "base.html" %}

{% block content %}
<div class="card">
  <div class="card-header">
    <ul class="nav nav-tabs card-header-tabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-status" type="button" role="tab">
          <i class="fas fa-info-circle me-1"></i>현재 상태
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-settings" type="button" role="tab">
          <i class="fas fa-sliders-h me-1"></i>설정
        </button>
      </li>
    </ul>
  </div>
  <div class="card-body">
    <div class="tab-content">
      <div class="tab-pane fade show active" id="tab-status" role="tabpanel">
        <div class="row g-3">
          <div class="col-lg-6">
            <div class="card bg-dark border-secondary">
              <div class="card-header border-secondary"><strong>상태</strong></div>
              <div class="card-body">
                <div class="mb-2">
                  자동매매 활성화:
                  <span class="badge bg-secondary" id="auto-enabled-badge">확인 중...</span>
                </div>
                <div class="mb-2">
                  장중 손절 감시:
                  <span class="badge bg-secondary" id="intraday-enabled-badge">확인 중...</span>
                  <span class="text-muted small ms-2" id="intraday-threshold-text"></span>
                </div>
                <div class="text-muted" id="status-box">로딩 중...</div>
                <hr class="border-secondary" />
                <div class="small text-muted" id="status-detail"></div>
                <div class="mt-3">
                  <button class="btn btn-outline-success" id="run-once-btn">
                    <i class="fas fa-play me-1"></i>즉시 실행(미리보기 후)
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="card bg-dark border-secondary">
              <div class="card-header border-secondary"><strong>안내</strong></div>
              <div class="card-body text-muted">
                - 즉시 실행은 분석서버 결과를 먼저 보여주고 확인 후 실행합니다.<br/>
                - 자동매매는 1분 주기 스케줄러로 동작하며, 활성화가 ON일 때만 실행됩니다.
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="tab-settings" role="tabpanel">
        <div class="row g-3">
          <div class="col-lg-8">
            <div class="card bg-dark border-secondary">
              <div class="card-header border-secondary"><strong>자동매매 설정</strong></div>
              <div class="card-body">
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" id="auto-enabled">
                  <label class="form-check-label" for="auto-enabled">자동매매 활성화</label>
                </div>
                <div class="card bg-dark border-secondary mb-3">
                  <div class="card-header border-secondary"><strong>실행 시간(1일 1회)</strong></div>
                  <div class="card-body">
                    <div class="row g-2 align-items-end">
                      <div class="col-md-6">
                        <label class="form-label">실행 시각(HH:MM)</label>
                        <input type="time" class="form-control form-control-sm" id="schedule-time" />
                        <div class="form-text text-muted">자동매매 ON일 때, 1분 주기 체크로 해당 시각에만 1일 1회 실행됩니다.</div>
                      </div>
                      <div class="col-md-6">
                        <div class="text-muted small" id="next-schedule-text">다음 실행시간 계산 중...</div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="row g-2 mb-3">
                  <div class="col-12">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="analysis-mock-enabled">
                      <label class="form-check-label" for="analysis-mock-enabled">분석 서버 Mock 모드</label>
                    </div>
                  </div>
                  <div class="col-md-8">
                    <label class="form-label">분석 서버 Host</label>
                    <input class="form-control form-control-sm" id="analysis-host" placeholder="localhost" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Port</label>
                    <input type="number" class="form-control form-control-sm" id="analysis-port" placeholder="5000" />
                  </div>
                  <div class="col-12">
                    <div class="small text-muted">분석 요청 경로는 내부 고정: <code>/analysis</code></div>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">1회 최대 매수 금액($)</label>
                    <input type="number" class="form-control form-control-sm" id="max-buy-amount" />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">매매 제외 예수금($)</label>
                    <input type="number" class="form-control form-control-sm" id="reserve-cash" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">익절(%)</label>
                    <input type="number" step="0.1" class="form-control form-control-sm" id="take-profit" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">손절(%)</label>
                    <input type="number" step="0.1" class="form-control form-control-sm" id="stop-loss" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">최대 보유(일)</label>
                    <input type="number" class="form-control form-control-sm" id="max-hold-days" />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">슬리피지(%)</label>
                    <input type="number" step="0.1" class="form-control form-control-sm" id="slippage-pct" />
                  </div>
                </div>
                <div class="d-flex gap-2">
                  <button class="btn btn-primary" id="save-btn">
                    <i class="fas fa-save me-1"></i>저장
                  </button>
                </div>
                <div class="form-text mt-2">
                  자동매매 활성화/전략은 <strong>저장 버튼</strong>을 눌렀을 때만 반영됩니다.
                </div>
              </div>
            </div>

            <div class="card bg-dark border-secondary mt-3">
              <div class="card-header border-secondary">
                <strong>장중 손절 감시 설정</strong>
                <small class="text-muted ms-2">(자동매매와 별개)</small>
              </div>
              <div class="card-body">
                <div class="form-check form-switch mb-3">
                  <input class="form-check-input" type="checkbox" id="intraday-enabled">
                  <label class="form-check-label" for="intraday-enabled">장중 손절 감시 활성화</label>
                </div>
                <div class="row g-2">
                  <div class="col-md-6">
                    <label class="form-label">기준(%)</label>
                    <input type="number" step="0.1" class="form-control form-control-sm" id="intraday-threshold-pct" />
                    <div class="form-text text-muted">예: <strong>-7</strong> 입력 → -7% 손절 감시 / <strong>+7</strong> 입력 → +7% 익절 감시</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="card bg-dark border-secondary">
              <div class="card-header border-secondary"><strong>주의</strong></div>
              <div class="card-body text-muted">
                - 실전 모드에서는 실제 주문이 나갑니다.<br/>
                - 분석 서버가 없으면 Mock 모드를 켜고 테스트하세요.
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function loadStrategy(){
    return fetch('/api/status').then(r=>r.json()).then(d=>{
      const mode = d.status.mode;
      return fetch('/api/auto-trading/strategy?mode='+mode).then(r=>r.json()).then(s=>{
        if(!s.success) return;
        document.getElementById('analysis-mock-enabled').checked = !!s.common.analysis_mock_enabled;
        document.getElementById('analysis-host').value = s.common.analysis_host || 'localhost';
        document.getElementById('analysis-port').value = s.common.analysis_port || 5000;

        document.getElementById('max-buy-amount').value = s.strategy.max_buy_amount ?? '';
        document.getElementById('reserve-cash').value = s.strategy.reserve_cash ?? '';
        document.getElementById('take-profit').value = s.strategy.take_profit_pct ?? '';
        document.getElementById('stop-loss').value = s.strategy.stop_loss_pct ?? '';
        document.getElementById('max-hold-days').value = s.strategy.max_hold_days ?? '';
        document.getElementById('slippage-pct').value = s.strategy.slippage_pct ?? 0.5;

        const intraday = s.intraday_stop_loss || {};
        document.getElementById('intraday-enabled').checked = !!intraday.enabled;
        const thr = (intraday.threshold_pct ?? (intraday.stop_loss_pct ? -Math.abs(intraday.stop_loss_pct) : -7.0));
        document.getElementById('intraday-threshold-pct').value = parseFloat(thr);

        const sch = s.schedule || {};
        document.getElementById('schedule-time').value = (sch.schedule_time || '22:30').slice(0,5);
        updateNextScheduleText();
      });
    });
  }

  function updateNextScheduleText(){
    const t = document.getElementById('schedule-time').value || '00:00';
    const [hh, mm] = t.split(':').map(x=>parseInt(x,10));
    const now = new Date();
    let next = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
    if(next <= now) next.setDate(next.getDate()+1);
    const pad = (n)=>(''+n).padStart(2,'0');
    document.getElementById('next-schedule-text').textContent =
      `다음 실행: ${next.getFullYear()}-${pad(next.getMonth()+1)}-${pad(next.getDate())} ${pad(next.getHours())}:${pad(next.getMinutes())}`;
  }

  function loadStatus(){
    fetch('/api/status').then(r=>r.json()).then(d=>{
      const mode = d.status.mode;
      fetch('/api/auto-trading/config?mode='+mode).then(r=>r.json()).then(cfg=>{
        document.getElementById('auto-enabled-badge').textContent = cfg.auto_trading_enabled ? 'ON' : 'OFF';
        document.getElementById('auto-enabled-badge').className = 'badge ' + (cfg.auto_trading_enabled ? 'bg-success' : 'bg-secondary');
        document.getElementById('status-box').innerText =
          'mode=' + mode + ', market_open=' + d.status.market_open + ', engine_running=' + d.status.is_running;
        document.getElementById('status-detail').innerText =
          'last_run=' + (d.status.engine_last_run_at || '-') +
          '\nnext_run=' + (d.status.engine_next_run_at || '-') +
          (d.status.engine_last_error ? ('\nlast_error=' + d.status.engine_last_error) : '');
      });

      // 장중 손절 감시 상태는 strategy endpoint에서 가져옴(보안/구조 통일)
      fetch('/api/auto-trading/strategy?mode='+mode).then(r=>r.json()).then(s=>{
        const intraday = (s && s.intraday_stop_loss) ? s.intraday_stop_loss : {};
        const enabled = !!intraday.enabled;
        document.getElementById('intraday-enabled-badge').textContent = enabled ? 'ON' : 'OFF';
        document.getElementById('intraday-enabled-badge').className = 'badge ' + (enabled ? 'bg-danger' : 'bg-secondary');
        const thr = (intraday.threshold_pct ?? (intraday.stop_loss_pct ? -Math.abs(intraday.stop_loss_pct) : -7.0));
        const thrNum = parseFloat(thr);
        const thrText = (thrNum >= 0 ? `+${thrNum}` : `${thrNum}`);
        document.getElementById('intraday-threshold-text').textContent = enabled ? `(기준: ${thrText}%)` : '';
      });
    });
  }

  document.getElementById('save-btn').addEventListener('click', function(){
    fetch('/api/status').then(r=>r.json()).then(d=>{
      const mode = d.status.mode;
      const payload = {
        mode: mode,
        auto_trading_enabled: document.getElementById('auto-enabled').checked,
        schedule: {
          schedule_time: (document.getElementById('schedule-time').value || '00:00').slice(0,5),
        },
        common: {
          analysis_mock_enabled: document.getElementById('analysis-mock-enabled').checked,
          analysis_host: document.getElementById('analysis-host').value.trim(),
          analysis_port: parseInt(document.getElementById('analysis-port').value, 10),
        },
        intraday_stop_loss: {
          enabled: document.getElementById('intraday-enabled').checked,
          threshold_pct: parseFloat(document.getElementById('intraday-threshold-pct').value),
        },
        strategy: {
          max_buy_amount: parseFloat(document.getElementById('max-buy-amount').value),
          reserve_cash: parseFloat(document.getElementById('reserve-cash').value),
          take_profit_pct: parseFloat(document.getElementById('take-profit').value),
          stop_loss_pct: parseFloat(document.getElementById('stop-loss').value),
          max_hold_days: parseInt(document.getElementById('max-hold-days').value, 10),
          slippage_pct: parseFloat(document.getElementById('slippage-pct').value),
        }
      };

      fetch('/api/auto-trading/strategy', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      }).then(r=>r.json()).then(resp=>{
        if(resp.success) alert('저장 완료');
        else alert('저장 실패: ' + (resp.message || 'unknown'));
        loadStrategy();
        loadStatus();
      });
    });
  });

  document.getElementById('run-once-btn').addEventListener('click', function(){
    // base.html의 미리보기 모달 재사용
    if(typeof openTradePreview === 'function'){
      openTradePreview();
    }else{
      alert('미리보기 기능이 준비되지 않았습니다.');
    }
  });

  loadStrategy();
  loadStatus();
  document.getElementById('schedule-time').addEventListener('change', updateNextScheduleText);
  setInterval(loadStatus, 5000);
</script>
{% endblock %}


